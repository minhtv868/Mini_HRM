@page
@model WebJob.Pages.HRM.DoashBoards.IndexModel
@await Component.InvokeAsync("FunctionFavorite")
<div class="card mt-2">
    <div class="card-header pt-1 car-header-padding">
        <form method="get" class="justify-content-between search-form">
			<div class="row gx-2 align-items-center mt-3">
				@*   <div class="col-12 mb-4 col-md-6 col-lg-4 col-xl-2 did-floating-label-content">
                    <select asp-for="Query.SiteId" asp-items="@(new SelectList(Model.SiteList, "SiteId", "SiteName"))"
                            class="form-select form-select-submit did-floating-select"
                            onclick="this.setAttribute('value', this.value); return false;"
                            onchange="this.setAttribute('value', this.value); return false;">
                    </select>
                    <label asp-for="Query.SiteId" class="did-floating-label"></label>
                </div>
				<div class="col-12 mb-4 col-md-6 col-lg-4 col-xl-2 did-floating-label-content">
					<input class="form-control did-floating-input" asp-for="Query.Keywords" asp-placeholder-for="Query.Keywords" type="search" />
					<label asp-for="Query.Keywords" class="did-floating-label"></label>
				</div> *@
			     
				@* <div class="col-12 mb-3 col-md-6 col-lg-4 col-xl-2">
					<smart-select-filter asp-for="Query.Orderby" 
										 enum-type="typeof(Domain.Enums.OrderByEnum)"
										 search-mode="none">
					</smart-select-filter>
				</div>
				<div class="col-12 mb-3 col-md-6 col-lg-4 col-xl-2">
					<smart-select-filter asp-for="Query.SortOrder"
										 enum-type="typeof(Domain.Enums.SortOrderEnum)"
										 search-mode="none">
					</smart-select-filter>
				</div> *@
				<div class="col-12 mb-4 col-md-6 col-lg-4 col-xl-2 did-floating-label-content">
					<button class="btn btn-secondary me-1" type="submit">Tìm kiếm</button>
				</div>
			</div>
        </form>
    </div>
    <div class="card-body p-0">
        @Html.AntiForgeryToken()
        <div class="table-responsive scrollbar">
            <div class="container">
                <div class="header">
                    <h1>🕐 Chấm Công</h1>
                    <div class="current-time" id="currentTime"></div>
                </div>

                <div class="status-card">
                    <div class="status-info">
                        <span class="status-label">Trạng thái hôm nay:</span>
                        <span class="status-value" id="todayStatus">Chưa check-in</span>
                    </div>
                    <div class="status-info">
                        <span class="status-label">Giờ vào:</span>
                        <span class="status-value" id="checkInTime">--:--</span>
                    </div>
                    <div class="status-info">
                        <span class="status-label">Giờ ra:</span>
                        <span class="status-value" id="checkOutTime">--:--</span>
                    </div>
                    <div class="status-info">
                        <span class="status-label">Tổng giờ làm:</span>
                        <span class="status-value" id="workHours">0.0h</span>
                    </div>
                </div>

                <div id="messageContainer"></div>

                <div class="location-info" id="locationInfo">
                    📍 Vị trí hiện tại: <span id="locationText">Đang xác định...</span>
                </div>

                <div id="map"></div>

                <div class="captcha-container" id="captchaContainer" >
                    <div class="g-recaptcha" data-sitekey="YOUR_SITE_KEY"></div>
                </div>

                <div class="btn-container">
                    <button class="btn" id="checkinBtn" onclick="handleCheckIn()">
                        <span id="checkinText">Check In</span>
                    </button>
                    <button class="btn checkout" id="checkoutBtn" onclick="handleCheckOut()" disabled>
                        <span id="checkoutText">Check Out</span>
                    </button>
                </div>

                <div class="security-info">
                    <h4>🔐 Thông tin bảo mật</h4>
                    <div>✓ Vị trí GPS được xác thực</div>
                    <div>✓ Địa chỉ IP được kiểm tra</div>
                    <div>✓ Thiết bị được nhận dạng</div>
                </div>

                <div class="device-info">
                    <div><strong>IP:</strong> <span id="userIP">Đang tải...</span></div>
                    <div><strong>Thiết bị:</strong> <span id="deviceType">Đang phát hiện...</span></div>
                    <div><strong>Trình duyệt:</strong> <span id="browserInfo">Đang phát hiện...</span></div>
                    <div><strong>Múi giờ:</strong> <span id="timezone">Đang phát hiện...</span></div>
                    <div>Platform: <span id="platform"></span></div>
                    <div>UserAgentData: <span id="uaData"></span></div>
                    <div>Fingerprint: <span id="fingerprint"></span></div>
                </div>
            </div>

            <!-- Google reCAPTCHA -->
            <script src="https://www.google.com/recaptcha/api.js" async defer></script>
         @*    @await Html.PartialAsync("BindData", Tuple.Create(Model.PaginatedResult, Model.PagingInput,Model.Query.SiteId)) *@
           
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                            class AntiStainceSystem {
                constructor() {
                    this.currentLocation = null;
                    this.deviceFingerprint = null;
                    this.userIP = null;
                    this.securityChecks = {
                        locationVerified: false,
                        deviceTrusted: false,
                        biometricPassed: false,
                        captchaPassed: false,
                        timeValid: false
                    };
                    this.allowedLocations = [
                        { lat: 21.0285, lng: 105.8542, radius: 100, name: "Văn phòng chính" },
                        { lat: 21.0245, lng: 105.8412, radius: 50, name: "Chi nhánh 1" }
                    ];
                    this.workingHours = {
                        start: "07:30",
                        end: "18:00",
                        lunchStart: "11:30",
                        lunchEnd: "13:00"
                    };
                    this.maxAttendanceDistance = 100; // mét
                    this.suspiciousActivities = [];
                    this.initializeSystem();
                }

                async initializeSystem() {
                    this.startSecurityMonitoring();
                    this.updateCurrentTime();
                    setInterval(() => this.updateCurrentTime(), 1000);

                    // Kiểm tra developer tools
                    this.detectDevTools();

                    await this.detectDevice();
                    await this.getUserIP();
                    await this.getCurrentLocation();
                    await this.generateAdvancedFingerprint();
                    await this.loadTodayStatus();

                    // Kiểm tra bảo mật toàn diện
                    await this.performSecurityChecks();

                    // Hiển thị captcha và biometric
                    this.showSecurityChallenges();
                }

                startSecurityMonitoring() {
                    // Chống thay đổi thời gian hệ thống
                    this.monitorTimeManipulation();

                    // Chống fake location
                    this.monitorLocationSpoofing();

                    // Chống automation/bot
                    this.monitorBotBehavior();

                    // Theo dõi tab switching
                    this.monitorTabSwitching();
                }

                monitorTimeManipulation() {
                    let serverTime = null;

                    // Lấy thời gian server
                    fetch('/api/time')
                        .then(res => res.json())
                        .then(data => {
                            serverTime = new Date(data.timestamp);

                            setInterval(() => {
                                const localTime = new Date();
                                const expectedTime = new Date(serverTime.getTime() + (Date.now() - serverTime.getTime()));
                                const timeDiff = Math.abs(localTime.getTime() - expectedTime.getTime());

                                if (timeDiff > 30000) { // 30 giây
                                    this.flagSuspiciousActivity('TIME_MANIPULATION', {
                                        localTime: localTime.toISOString(),
                                        expectedTime: expectedTime.toISOString(),
                                        difference: timeDiff
                                    });
                                }
                            }, 10000);
                        })
                        .catch(() => {
                            // Fallback: sử dụng multiple time sources
                            this.crossVerifyTime();
                        });
                }

                async crossVerifyTime() {
                    const timeSources = [
                        'https://worldtimeapi.org/api/timezone/Asia/Ho_Chi_Minh',
                        'https://api.timezonedb.com/v2.1/get-time-zone'
                    ];

                    const times = [];
                    for (const source of timeSources) {
                        try {
                            const response = await fetch(source);
                            const data = await response.json();
                            times.push(new Date(data.datetime || data.formatted).getTime());
                        } catch (e) {
                            console.warn('Time source unavailable:', source);
                        }
                    }

                    if (times.length >= 2) {
                        const avgTime = times.reduce((a, b) => a + b) / times.length;
                        const localTime = Date.now();

                        if (Math.abs(localTime - avgTime) > 60000) { // 1 phút
                            this.flagSuspiciousActivity('TIME_SYNC_ISSUE', {
                                localTime,
                                serverTime: avgTime,
                                difference: Math.abs(localTime - avgTime)
                            });
                        }
                    }
                }

                monitorLocationSpoofing() {
                    let locationChecks = 0;
                    let consistentLocation = null;

                    const checkLocation = () => {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const currentPos = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude,
                                    accuracy: position.coords.accuracy,
                                    timestamp: position.timestamp
                                };

                                // Kiểm tra độ chính xác GPS
                                if (currentPos.accuracy > 1000) {
                                    this.flagSuspiciousActivity('LOW_GPS_ACCURACY', {
                                        accuracy: currentPos.accuracy,
                                        location: currentPos
                                    });
                                }

                                // Kiểm tra tính nhất quán vị trí
                                if (consistentLocation) {
                                    const distance = this.calculateDistance(
                                        consistentLocation.lat, consistentLocation.lng,
                                        currentPos.lat, currentPos.lng
                                    );

                                    if (distance > 500 && locationChecks < 5) { // 500m trong 5 lần check đầu
                                        this.flagSuspiciousActivity('LOCATION_JUMPING', {
                                            previousLocation: consistentLocation,
                                            currentLocation: currentPos,
                                            distance: distance
                                        });
                                    }
                                }

                                consistentLocation = currentPos;
                                locationChecks++;
                            },
                            (error) => {
                                this.flagSuspiciousActivity('GPS_ERROR', {
                                    error: error.message,
                                    code: error.code
                                });
                            },
                            {
                                enableHighAccuracy: true,
                                timeout: 10000,
                                maximumAge: 0
                            }
                        );
                    };

                    // Kiểm tra vị trí định kỳ
                    checkLocation();
                    setInterval(checkLocation, 30000); // Mỗi 30 giây
                }

                monitorBotBehavior() {
                    let mouseMovements = 0;
                    let keystrokes = 0;
                    let clickPatterns = [];

                    document.addEventListener('mousemove', () => mouseMovements++);
                    document.addEventListener('keydown', () => keystrokes++);
                    document.addEventListener('click', (e) => {
                        clickPatterns.push({
                            x: e.clientX,
                            y: e.clientY,
                            timestamp: Date.now()
                        });
                    });

                    // Kiểm tra hành vi người dùng sau 2 phút
                    setTimeout(() => {
                        if (mouseMovements === 0 && keystrokes === 0) {
                            this.flagSuspiciousActivity('NO_HUMAN_INTERACTION', {
                                mouseMovements,
                                keystrokes,
                                duration: 120000
                            });
                        }

                        // Phân tích pattern click
                        if (clickPatterns.length > 5) {
                            const isRobotic = this.analyzeClickPatterns(clickPatterns);
                            if (isRobotic) {
                                this.flagSuspiciousActivity('ROBOTIC_BEHAVIOR', {
                                    clickPatterns: clickPatterns.slice(-10)
                                });
                            }
                        }
                    }, 120000);
                }

                analyzeClickPatterns(patterns) {
                    if (patterns.length < 5) return false;

                    const intervals = [];
                    for (let i = 1; i < patterns.length; i++) {
                        intervals.push(patterns[i].timestamp - patterns[i-1].timestamp);
                    }

                    // Kiểm tra interval quá đều đặn (bot behavior)
                    const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                    const variance = intervals.reduce((acc, val) => acc + Math.pow(val - avgInterval, 2), 0) / intervals.length;

                    return variance < 1000; // Variance thấp = robotic
                }

                monitorTabSwitching() {
                    let tabSwitches = 0;
                    let isHidden = false;

                    document.addEventListener('visibilitychange', () => {
                        if (document.hidden && !isHidden) {
                            tabSwitches++;
                            isHidden = true;

                            if (tabSwitches > 3) {
                                this.flagSuspiciousActivity('EXCESSIVE_TAB_SWITCHING', {
                                    switchCount: tabSwitches
                                });
                            }
                        } else if (!document.hidden) {
                            isHidden = false;
                        }
                    });
                }

                detectDevTools() {
                    // Method 1: Console detection
                    let devtools = {open: false, orientation: null};
                    const threshold = 160;

                    setInterval(() => {
                        if (window.outerHeight - window.innerHeight > threshold ||
                            window.outerWidth - window.innerWidth > threshold) {
                            if (!devtools.open) {
                                devtools.open = true;
                                this.flagSuspiciousActivity('DEVTOOLS_DETECTED', {
                                    method: 'window_size_check'
                                });
                            }
                        } else {
                            devtools.open = false;
                        }
                    }, 1000);

                    // Method 2: Debug detection
                    let startTime = Date.now();
                    debugger;
                    if (Date.now() - startTime > 100) {
                        this.flagSuspiciousActivity('DEBUGGER_DETECTED', {
                            timeDelay: Date.now() - startTime
                        });
                    }
                }

                async getCurrentLocation() {
                    return new Promise((resolve, reject) => {
                        if (!navigator.geolocation) {
                            this.showError('Trình duyệt không hỗ trợ định vị GPS');
                            reject('GPS not supported');
                            return;
                        }

                        const options = {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 0
                        };

                        navigator.geolocation.getCurrentPosition(
                            async (position) => {
                                this.currentLocation = {
                                    lat: position.coords.latitude,
                                    lng: position.coords.longitude,
                                    accuracy: position.coords.accuracy,
                                    timestamp: position.timestamp
                                };

                                // Kiểm tra vị trí có hợp lệ không
                                const locationValid = await this.verifyLocation(this.currentLocation);
                                this.securityChecks.locationVerified = locationValid;

                                document.getElementById('locationInfo').textContent =
                                    `Vĩ độ: ${this.currentLocation.lat.toFixed(5)}, ` +
                                    `Kinh độ: ${this.currentLocation.lng.toFixed(5)}, ` +
                                    `Độ chính xác: ${this.currentLocation.accuracy.toFixed(0)}m`;

                                resolve(this.currentLocation);
                            },
                            (error) => {
                                console.error('GPS error:', error);
                                document.getElementById('locationInfo').textContent = 'Không lấy được vị trí';
                                this.flagSuspiciousActivity('GPS_DENIED', {
                                    error: error.message,
                                    code: error.code
                                });
                                reject(error);
                            },
                            options
                        );
                    });
                }

                async verifyLocation(location) {
                    // Kiểm tra vị trí có trong phạm vi cho phép
                    for (const allowedLocation of this.allowedLocations) {
                        const distance = this.calculateDistance(
                            location.lat, location.lng,
                            allowedLocation.lat, allowedLocation.lng
                        );

                        if (distance <= allowedLocation.radius) {
                            return true;
                        }
                    }

                    // Kiểm tra IP geolocation có khớp với GPS không
                    try {
                        const ipLocation = await this.getIPLocation();
                        const distance = this.calculateDistance(
                            location.lat, location.lng,
                            ipLocation.lat, ipLocation.lng
                        );

                        if (distance > 50000) { // 50km
                            this.flagSuspiciousActivity('LOCATION_IP_MISMATCH', {
                                gpsLocation: location,
                                ipLocation: ipLocation,
                                distance: distance
                            });
                        }
                    } catch (e) {
                        console.warn('Cannot verify IP location:', e);
                    }

                    return false;
                }

                async getIPLocation() {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    return {
                        lat: data.latitude,
                        lng: data.longitude,
                        city: data.city,
                        region: data.region
                    };
                }

                calculateDistance(lat1, lon1, lat2, lon2) {
                    const R = 6371000; // Earth radius in meters
                    const dLat = this.toRad(lat2 - lat1);
                    const dLon = this.toRad(lon2 - lon1);
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(this.toRad(lat1)) * Math.cos(this.toRad(lat2)) *
                            Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    return R * c;
                }

                toRad(deg) {
                    return deg * (Math.PI/180);
                }

                async generateAdvancedFingerprint() {
                    const components = [];

                    // Canvas fingerprinting
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    ctx.textBaseline = "top";
                    ctx.font = "14px 'Arial'";
                    ctx.textBaseline = "alphabetic";
                    ctx.fillStyle = "#f60";
                    ctx.fillRect(125,1,62,20);
                    ctx.fillStyle = "#069";
                    ctx.fillText("attendance-system-" + Date.now(), 2, 15);
                    ctx.fillStyle = "rgba(102, 204, 0, 0.7)";
                    ctx.fillText("anti-fraud-check", 4, 17);
                    components.push(canvas.toDataURL());

                    // WebGL fingerprinting
                    const gl = canvas.getContext('webgl');
                    if (gl) {
                        const renderer = gl.getParameter(gl.RENDERER);
                        const vendor = gl.getParameter(gl.VENDOR);
                        components.push(renderer + vendor);
                    }

                    // Audio fingerprinting
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const analyser = audioContext.createAnalyser();
                        const gainNode = audioContext.createGain();

                        oscillator.connect(analyser);
                        analyser.connect(gainNode);
                        gainNode.connect(audioContext.destination);

                        oscillator.frequency.value = 1000;
                        gainNode.gain.value = 0;

                        const freqData = new Uint8Array(analyser.frequencyBinCount);
                        analyser.getByteFrequencyData(freqData);
                        components.push(freqData.join(','));

                        audioContext.close();
                    } catch (e) {
                        components.push('audio_unavailable');
                    }

                    // Hardware fingerprinting
                    components.push(navigator.hardwareConcurrency || 'unknown');
                    components.push(screen.width + 'x' + screen.height);
                    components.push(screen.colorDepth);
                    components.push(navigator.language);
                    components.push(navigator.languages.join(','));
                    components.push(navigator.platform);
                    components.push(navigator.cookieEnabled);
                    components.push(navigator.doNotTrack);

                    // Timezone fingerprinting
                    components.push(Intl.DateTimeFormat().resolvedOptions().timeZone);
                    components.push(new Date().getTimezoneOffset());

                    // Generate final fingerprint
                    const fingerprintString = components.join('|');
                    this.deviceFingerprint = await this.sha256(fingerprintString);

                    document.getElementById('fingerprint').textContent = this.deviceFingerprint.substring(0, 16);
                }

                async sha256(message) {
                    const msgBuffer = new TextEncoder().encode(message);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                }

                async performSecurityChecks() {
                    // Kiểm tra thời gian làm việc
                    this.securityChecks.timeValid = this.isWorkingTime();

                    // Kiểm tra device đã được trust chưa
                    this.securityChecks.deviceTrusted = await this.checkDeviceTrust();

                    this.updateSecurityStatus();
                }

                isWorkingTime() {
                    const now = new Date();
                    const currentTime = now.getHours().toString().padStart(2, '0') + ':' +
                                       now.getMinutes().toString().padStart(2, '0');

                    const isWeekend = now.getDay() === 0 || now.getDay() === 6;

                    if (isWeekend) {
                        this.flagSuspiciousActivity('WEEKEND_ATTENDANCE', {
                            day: now.getDay(),
                            time: currentTime
                        });
                        return false;
                    }

                    const startTime = this.workingHours.start;
                    const endTime = this.workingHours.end;

                    return currentTime >= startTime && currentTime <= endTime;
                }

                async checkDeviceTrust() {
                    const trustedDevices = JSON.parse(sessionStorage.getItem('trustedDevices') || '[]');
                    return trustedDevices.includes(this.deviceFingerprint);
                }

                showSecurityChallenges() {
                    // Hiển thị CAPTCHA
                    if (!sessionStorage.getItem('captchaPassedToday')) {
                        this.showCaptcha();
                    }

                    // Hiển thị biometric nếu có
                    if ('credentials' in navigator) {
                        this.showBiometricAuth();
                    }
                }

                showCaptcha() {
                    const captchaDiv = document.createElement('div');
                    captchaDiv.innerHTML = `
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                                    background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
                                    justify-content: center; align-items: center;">
                            <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                                <h3>Xác thực bảo mật</h3>
                                <div id="captchaChallenge" style="margin: 20px 0; font-size: 24px;
                                                                font-weight: bold; background: #f0f0f0;
                                                                padding: 10px; border-radius: 5px;"></div>
                                <input type="text" id="captchaInput" placeholder="Nhập mã xác thực"
                                       style="padding: 10px; margin: 10px; font-size: 16px;">
                                <br>
                                <button onclick="attendanceSystem.verifyCaptcha()"
                                        style="background: #007bff; color: white; padding: 10px 20px;
                                               border: none; border-radius: 5px; cursor: pointer;">
                                    Xác thực
                                </button>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(captchaDiv);
                    this.generateCaptcha();
                }

                generateCaptcha() {
                    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
                    this.captchaCode = '';
                    for (let i = 0; i < 6; i++) {
                        this.captchaCode += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    document.getElementById('captchaChallenge').textContent = this.captchaCode;
                }

                verifyCaptcha() {
                    const input = document.getElementById('captchaInput').value;
                    if (input === this.captchaCode) {
                        this.securityChecks.captchaPassed = true;
                        sessionStorage.setItem('captchaPassedToday', new Date().toDateString());
                        document.querySelector('[style*="position: fixed"]').remove();
                        this.updateSecurityStatus();
                    } else {
                        alert('Mã xác thực không đúng, vui lòng thử lại');
                        this.generateCaptcha();
                        this.flagSuspiciousActivity('CAPTCHA_FAILED', {
                            input: input,
                            expected: this.captchaCode
                        });
                    }
                }

                async showBiometricAuth() {
                    try {
                        const credential = await navigator.credentials.create({
                            publicKey: {
                                challenge: new TextEncoder().encode('attendance-auth'),
                                rp: { name: "Attendance System" },
                                user: {
                                    id: new TextEncoder().encode("user"),
                                    name: "employee",
                                    displayName: "Employee"
                                },
                                pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                                timeout: 60000,
                                authenticatorSelection: {
                                    authenticatorAttachment: "platform",
                                    userVerification: "required"
                                }
                            }
                        });

                        if (credential) {
                            this.securityChecks.biometricPassed = true;
                            this.updateSecurityStatus();
                        }
                    } catch (e) {
                        console.log('Biometric auth not available or failed:', e);
                    }
                }

                flagSuspiciousActivity(type, details) {
                    const activity = {
                        type: type,
                        details: details,
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        fingerprint: this.deviceFingerprint,
                        location: this.currentLocation
                    };

                    this.suspiciousActivities.push(activity);

                    // Log cảnh báo
                    console.warn('🚨 Suspicious Activity Detected:', activity);

                    // Gửi lên server để xử lý
                    this.reportSuspiciousActivity(activity);

                    // Hiển thị cảnh báo nếu nghiêm trọng
                    const criticalTypes = ['DEVTOOLS_DETECTED', 'TIME_MANIPULATION', 'LOCATION_IP_MISMATCH'];
                    if (criticalTypes.includes(type)) {
                        this.showWarning(`Phát hiện hành vi nghi vấn: ${type}`);
                    }
                }

                async reportSuspiciousActivity(activity) {
                    try {
                        await fetch('/api/security/report', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(activity)
                        });
                    } catch (e) {
                        console.error('Cannot report suspicious activity:', e);
                    }
                }

                updateSecurityStatus() {
                    const status = document.getElementById('securityStatus');
                    if (!status) return;

                    const checks = this.securityChecks;
                    const passedChecks = Object.values(checks).filter(Boolean).length;
                    const totalChecks = Object.keys(checks).length;

                    let statusText = `Bảo mật: ${passedChecks}/${totalChecks} ✓`;
                    let statusColor = passedChecks === totalChecks ? 'green' :
                                     passedChecks >= totalChecks * 0.7 ? 'orange' : 'red';

                    status.innerHTML = `<span style="color: ${statusColor}">${statusText}</span>`;

                    // Hiển thị chi tiết
                    const details = Object.entries(checks)
                        .map(([key, value]) => `${key}: ${value ? '✓' : '✗'}`)
                        .join('<br>');

                    if (document.getElementById('securityDetails')) {
                        document.getElementById('securityDetails').innerHTML = details;
                    }
                }

                showWarning(message) {
                    const warning = document.createElement('div');
                    warning.innerHTML = `
                        <div style="position: fixed; top: 20px; right: 20px; background: #ff6b6b;
                                    color: white; padding: 15px; border-radius: 5px; z-index: 1001;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                            <strong>⚠️ Cảnh báo bảo mật</strong><br>
                            ${message}
                            <button onclick="this.parentElement.remove()"
                                    style="float: right; background: none; border: none;
                                           color: white; cursor: pointer; margin-left: 10px;">×</button>
                        </div>
                    `;
                    document.body.appendChild(warning);

                    // Tự động ẩn sau 5 giây
                    setTimeout(() => {
                        if (warning.parentNode) {
                            warning.remove();
                        }
                    }, 5000);
                }

                async checkIn() {
                    // Kiểm tra tất cả điều kiện bảo mật
                    const securityPassed = Object.values(this.securityChecks).every(Boolean);

                    if (!securityPassed) {
                        this.showError('Vui lòng hoàn thành tất cả kiểm tra bảo mật trước khi chấm công');
                        return false;
                    }

                    if (this.suspiciousActivities.length > 5) {
                        this.showError('Phát hiện nhiều hoạt động nghi vấn. Không thể chấm công.');
                        return false;
                    }

                    // Kiểm tra vị trí một lần nữa
                    const currentLocation = await this.getCurrentLocation();
                    const locationValid = await this.verifyLocation(currentLocation);

                    if (!locationValid) {
                        this.showError('Bạn không ở trong phạm vi cho phép chấm công');
                        return false;
                    }

                    // Tạo dữ liệu chấm công
                    const attendanceData = {
                        timestamp: new Date().toISOString(),
                        location: this.currentLocation,
                        deviceFingerprint: this.deviceFingerprint,
                        userIP: this.userIP,
                        securityChecks: this.securityChecks,
                        suspiciousActivities: this.suspiciousActivities,
                        browserInfo: this.getBrowserInfo(),
                        type: 'check_in'
                    };

                    // Gửi lên server
                    try {
                        const response = await fetch('/api/attendance/checkin', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(attendanceData)
                        });

                        if (response.ok) {
                            alert('Chấm công thành công!');
                            this.loadTodayStatus();
                            return true;
                        } else {
                            throw new Error('Server error');
                        }
                    } catch (e) {
                        this.showError('Lỗi kết nối server. Vui lòng thử lại.');
                        return false;
                    }
                }

                // Các method khác giữ nguyên từ code gốc...
                updateCurrentTime() {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('vi-VN', {
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    const dateString = now.toLocaleDateString('vi-VN', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                    document.getElementById('currentTime').innerHTML =
                        `<div style="font-size: 0.8em; color: #888;">${dateString}</div>
                         <div>${timeString}</div>`;
                }

                async detectDevice() {
                    const device = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'mobile' : 'web';
                    const browser = this.getBrowserInfo();
                    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    const platform = navigator.platform;
                    const uaData = navigator.userAgentData ? JSON.stringify(navigator.userAgentData) : 'N/A';

                    document.getElementById('deviceType').textContent = device;
                    document.getElementById('browserInfo').textContent = browser;
                    document.getElementById('timezone').textContent = timezone;
                    document.getElementById('platform').textContent = platform;
                    document.getElementById('uaData').textContent = uaData;
                }

                getBrowserInfo() {
                    const ua = navigator.userAgent;
                    if (ua.includes('Chrome')) return 'Chrome';
                    if (ua.includes('Firefox')) return 'Firefox';
                    if (ua.includes('Safari')) return 'Safari';
                    if (ua.includes('Edge')) return 'Edge';
                    return 'Unknown';
                }

                async getUserIP() {
                    try {
                        const response = await fetch('https://api.ipify.org?format=json');
                        const data = await response.json();
                        this.userIP = data.ip;
                        document.getElementById('userIP').textContent = data.ip;
                    } catch (error) {
                        console.error('Cannot get IP:', error);
                        document.getElementById('userIP').textContent = 'Không xác định';
                    }
                }

               // async loadTodayStatus() {
                    // Demo dữ liệu giả - thay b
                    }
            </script>

                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .cards { display: flex; gap: 20px; margin-bottom: 30px; }
                    .card {
                      flex: 1;
                      padding: 20px;
                      background: #f7f7f7;
                      border-radius: 10px;
                      text-align: center;
                      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                    }
                    .card h2 { margin: 0; font-size: 28px; color: #333; }
                    .card p { margin: 5px 0 0; font-size: 14px; color: #666; }
                    .charts { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; }
                    canvas { background: #fff; border-radius: 10px; padding: 10px; }
                </style>
            <style>
                

                .container {
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-radius: 20px;
                    padding: 40px;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                    max-width: 500px;
                    width: 100%;
                    text-align: center;
                }

                .header {
                    margin-bottom: 30px;
                }

                    .header h1 {
                        color: #333;
                        margin-bottom: 10px;
                        font-size: 28px;
                    }

                .current-time {
                    font-size: 24px;
                    color: #666;
                    font-weight: 600;
                    margin: 20px 0;
                }

                .status-card {
                    background: #f8f9ff;
                    border-radius: 12px;
                    padding: 20px;
                    margin: 20px 0;
                    border-left: 4px solid #667eea;
                }

                .status-info {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin: 10px 0;
                }

                .status-label {
                    font-weight: 600;
                    color: #555;
                }

                .status-value {
                    color: #333;
                    font-weight: 500;
                }

                    .status-value.success {
                        color: #22c55e;
                    }

                    .status-value.warning {
                        color: #f59e0b;
                    }

                .btn {
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 15px 30px;
                    border-radius: 12px;
                    font-size: 16px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    margin: 10px;
                    min-width: 120px;
                }

                    .btn:hover {
                        transform: translateY(-2px);
                        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
                    }

                    .btn:disabled {
                        background: #ccc;
                        cursor: not-allowed;
                        transform: none;
                        box-shadow: none;
                    }

                    .btn.checkout {
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    }

                        .btn.checkout:hover {
                            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.3);
                        }

                .location-info {
                    background: #ecfdf5;
                    border: 1px solid #a7f3d0;
                    border-radius: 8px;
                    padding: 12px;
                    margin: 15px 0;
                    font-size: 14px;
                    color: #065f46;
                }

                .error {
                    background: #fef2f2;
                    border: 1px solid #fecaca;
                    color: #dc2626;
                    padding: 12px;
                    border-radius: 8px;
                    margin: 15px 0;
                    font-size: 14px;
                }

                .success {
                    background: #f0fdf4;
                    border: 1px solid #bbf7d0;
                    color: #166534;
                    padding: 12px;
                    border-radius: 8px;
                    margin: 15px 0;
                    font-size: 14px;
                }

                .loading {
                    display: inline-block;
                    width: 20px;
                    height: 20px;
                    border: 3px solid #f3f3f3;
                    border-top: 3px solid #667eea;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin-right: 10px;
                }

                @@keyframes spin {
                    0%

                {
                    transform: rotate(0deg);
                }

                100% {
                    transform: rotate(360deg);
                }

                }

                .security-info {
                    background: #fffbeb;
                    border: 1px solid #fed7aa;
                    border-radius: 8px;
                    padding: 15px;
                    margin: 20px 0;
                    font-size: 13px;
                    color: #92400e;
                }

                    .security-info h4 {
                        margin-bottom: 8px;
                        color: #b45309;
                    }

                .device-info {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    font-size: 12px;
                    color: #666;
                    margin-top: 15px;
                }

                .captcha-container {
                    margin: 20px 0;
                    padding: 15px;
                    border: 1px dashed #ddd;
                    border-radius: 8px;
                    background: #fafafa;
                }

                #map {
                    height: 200px;
                    width: 100%;
                    border-radius: 8px;
                    margin: 15px 0;
                    display: none;
                }

                @@media (max-width: 480px) {
                    .container

                {
                    padding: 20px;
                    margin: 10px;
                }

                .device-info {
                    grid-template-columns: 1fr;
                }

                }
            </style>
                <h1>Dashboard - Mini HRM</h1>

                <!-- Thẻ thống kê -->
                <div class="cards">
                    <div class="card">
                        <h2>120</h2>
                        <p>Nhân viên</p>
                    </div>
                    <div class="card">
                        <h2>98</h2>
                        <p>Chấm công hôm nay</p>
                    </div>
                    <div class="card">
                        <h2>5</h2>
                        <p>Đang nghỉ phép</p>
                    </div>
                    <div class="card">
                        <h2>12</h2>
                        <p>Yêu cầu chờ duyệt</p>
                    </div>
                </div>

                <!-- Biểu đồ -->
                <div class="charts">
                    <canvas id="chartDept"></canvas>
                    <canvas id="chartLate"></canvas>
                    <canvas id="chartSalary"></canvas>
                    <canvas id="chartOvertime"></canvas>
                </div>

                <script>
                    // Pie chart: Tỉ lệ nhân viên theo phòng ban
                    new Chart(document.getElementById("chartDept"), {
                      type: "pie",
                      data: {
                        labels: ["IT", "HR", "Finance", "Sales"],
                        datasets: [{
                          data: [40, 20, 30, 30],
                          backgroundColor: ["#4CAF50", "#FF9800", "#2196F3", "#9C27B0"]
                        }]
                      },
                      options: { plugins: { title: { display: true, text: "Nhân viên theo phòng ban" } } }
                    });

                    // Bar chart: Đi muộn theo tuần
                    new Chart(document.getElementById("chartLate"), {
                      type: "bar",
                      data: {
                        labels: ["T2", "T3", "T4", "T5", "T6"],
                        datasets: [{
                          label: "Số lần đi muộn",
                          data: [5, 8, 3, 6, 4],
                          backgroundColor: "#FF5722"
                        }]
                      },
                      options: { plugins: { title: { display: true, text: "Đi muộn trong tuần" } } }
                    });

                    // Line chart: Mức lương trung bình theo tháng
                    new Chart(document.getElementById("chartSalary"), {
                      type: "line",
                      data: {
                        labels: ["1", "2", "3", "4", "5", "6"],
                        datasets: [{
                          label: "Lương trung bình (triệu VND)",
                          data: [12, 13, 14, 13, 15, 16],
                          borderColor: "#3F51B5",
                          fill: false
                        }]
                      },
                      options: { plugins: { title: { display: true, text: "Lương trung bình theo tháng" } } }
                    });

                    // Doughnut chart: Overtime theo tháng
                    new Chart(document.getElementById("chartOvertime"), {
                      type: "doughnut",
                      data: {
                        labels: ["OT <= 10h", "OT 10-20h", "OT > 20h"],
                        datasets: [{
                          data: [50, 30, 20],
                          backgroundColor: ["#FFC107", "#00BCD4", "#E91E63"]
                        }]
                      },
                      options: { plugins: { title: { display: true, text: "Phân bổ Overtime" } } }
                    });
                </script>
        </div>
    </div>
</div>
